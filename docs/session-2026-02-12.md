# Session Summary – February 12, 2026

## Overview

Continued migration of SM/SMD device pages from ClearSilver/HDF to Svelte + JSON REST API. Completed all remaining Switching pages and fixed a reactivity bug.

## Pages Completed

### 1. Switching / Virt. Rotators (`sm_antsw_vr_list`)

- Virtual rotators are groups (`type=1`) with `virtual_rotator=1`
- Main rows show VR label/display, editable in Edit mode
- Nested ref sub-rows show azimuth min/max, RX-Only (read-only from referenced antenna), and antenna dropdown
- "Add Antenna" button per VR opens inline form with azimuth fields and antenna selector
- Full CRUD: Add VR, Edit (label/display/refs), Remove (VRs and individual refs via compound `vrId:refId` keys)
- Shared helpers added: `smAllObjects`, `smObjDisplay`, `smObjRxOnly`

### 2. Switching / Ant. Groups (`sm_antsw_grp_list`)

- Antenna groups are groups (`type=1`) with `virtual_rotator=0`
- Simplified version of VR page — no azimuth columns
- Columns: Checkbox, ID, Label, Name, RX-Only, Antenna
- Same CRUD pattern: Add group, Edit, Remove, Add Antenna to group
- Reuses `smAllObjects`, `smObjDisplay`, `smObjRxOnly` helpers from VR

### 3. Switching / Bands (`sm_antsw_band_list`)

- Bands are `type=2` objects with fields: display, low_freq, high_freq, bcd_code, pa_power, keyout
- **BPF column**: Nested sub-table showing outputs classified as BPF (`sm.output[name] === 1`) with per-output checkboxes tied to `bpf_seq`
- **SEQ column**: Nested sub-table showing outputs classified as SEQ/SEQINV (`sm.output[name] === 2 || 3`)
- **Ref rows**: Each band references antennas/groups with `ANT:/VIR:/GRP:` prefixed dropdown (filters to type 0 and 1 only). Each ref has an RX-only toggle. When ref points to an antenna, shows the antenna's output settings for ANT-class outputs.
- Inline Add ref with Save/Cancel per band row
- New helpers: `smBands`, `smBpfOutputs`, `smAntOutputs`, `smObjTypedDisplay`, `smAntsAndGroups`

## Bug Fix: Svelte Reactivity on Add Antenna/Ref

**Problem**: After adding an antenna reference to a VR or Group and pressing Save, the new ref didn't appear in the read-only view until page reload. Same issue on both VR and Groups pages.

**Root Cause**: Svelte 4's `{@const}` declarations in `{:else if}` blocks don't establish reactive dependency tracking through function calls. When `configDevices` was reassigned after save, the template didn't know that `smVirtualRotators()` / `smGroups()` depended on it.

**Fix**: Added `$:` reactive declarations that explicitly reference `configDevices`:

```javascript
$: activeVrs = configDevices && activeSerial ? smVirtualRotators(activeSerial) : [];
$: activeGrps = configDevices && activeSerial ? smGroups(activeSerial) : [];
$: activeAllObjs = configDevices && activeSerial ? smAllObjects(activeSerial) : [];
// etc.
```

Template `{@const}` now aliases these reactive variables instead of calling functions directly. Applied consistently to Antennas, VR, Groups, and Bands pages.

## Files Modified

- **`webui/svelte/src/App.svelte`** — All UI changes:
  - State variables: `smVrMode`, `smVrAddForm`, `smVrEditForms`, `smVrSelected`, `smVrAddAnt`, `smGrpMode`, `smGrpAddForm`, `smGrpEditForms`, `smGrpSelected`, `smGrpAddAnt`, `smBndMode`, `smBndAddForm`, `smBndEditForms`, `smBndSelected`, `smBndAddRef`
  - Helper functions for each page's CRUD operations
  - Template sections for VR, Groups, and Bands
  - `$:` reactive declarations for data dependent on `configDevices`
  - CSS: `.vr-main-row` for group/VR/band main row styling

- **`webui/svelte/src/app.css`** — `.vr-main-row` styling (blue background, bold text)

## Backend Changes (earlier in this session)

### HDF Dependency Removal from `cfgmgrj.c`

- Added `sm_antsw_to_json()` directly in `mhsm.c` — exports all SM data (fixed settings, output classification, objects with refs) as JSON
- `cfgmgrj.c` `build_sm_json()` now calls `sm_antsw_to_json(sm)` directly instead of going through a ClearSilver HDF bridge
- Eliminated the `cfg_to_json` intermediary for SM data

### JSON-based SM Object CRUD (`mhsm.c`)

- Added JSON helper functions: `json_int_or()`, `json_str_or()` (static utilities)
- **Dispatcher functions**: `sm_antsw_add_obj_json()` and `sm_antsw_mod_obj_json()` — dispatch by `type` field to type-specific handlers
- **Antenna (type=0)**: `sm_antsw_add_ant_json()`, `sm_antsw_mod_ant_json()` — handle label, display, steppir, rxonly, pa_ant_number, rotator, rotator_offset, output settings
- **Group (type=1)**: `sm_antsw_add_group_json()`, `sm_antsw_mod_group_json()` — handle label, display, num_antennas, rxonly, virtual_rotator, refs with dest_id/min_azimuth/max_azimuth
- **Band (type=2)**: `sm_antsw_add_band_json()`, `sm_antsw_mod_band_json()` — handle display, low_freq, high_freq, bcd_code, keyout, pa_power, bpf_seq (per-output bits), refs with dest_id/rxonly/flags

### REST API Dispatch (`cfgmgrj.c`)

- `apply_sm_from_json()` handles `sm.obj` in two forms:
  - **Array** (bulk load from saved config file): calls `sm_antsw_clear_lists()` then iterates with `sm_antsw_add_obj_json()`
  - **Object** (live PATCH operations): dispatches on `action` field:
    - `"add"` → `sm_antsw_add_obj_json()`
    - `"mod"` → `sm_antsw_mod_obj_json()`
    - `"rem"` → `sm_antsw_rem_obj()` (by id)
    - `"rem_ref"` → `sm_antsw_rem_obj_ref()` (by obj_id + ref_id)

### Config File Persistence Fix

- Discovered that `apply_sm_from_json` only handled `sm.obj` as a single object (PATCH API), not as an array (loading from saved config file)
- Added `json_is_array()` branch: clears existing lists with `sm_antsw_clear_lists()`, then iterates array elements with `sm_antsw_add_obj_json()`
- Confirmed saves and loads correctly after fix

### Files Modified (Backend)

- **`src/mhsm.c`** — `sm_antsw_to_json()`, all `*_json()` CRUD functions, JSON helpers
- **`src/mhsm.h`** — Declarations for `sm_antsw_to_json()`, `sm_antsw_add_obj_json()`, `sm_antsw_mod_obj_json()`
- **`src/cfgmgrj.c`** — `apply_sm_from_json()` with action dispatch and array load, `build_sm_json()` using direct `sm_antsw_to_json()`

## Status

All SM/SMD Switching pages are now complete:
- ✅ Load/Store
- ✅ Settings
- ✅ Outputs
- ✅ Antennas
- ✅ Virtual Rotators
- ✅ Antenna Groups
- ✅ Bands
- ✅ All Parameters (was already done)
